# 杂项3 高速局域网与系统集成

## 一个完成的网络系统包括哪些要素

通信介质 通信平台 资源系统 网管员

## 重点知识

1. 以太网通信原理，交换机原理，多层交换技术
2. 交换机安装与调试，交换机连接技术
3. 基于802.1Q协议的多层网络组建技术 
4. 虚拟局域网的设计， VLAN间路由配置
5. 依据用户组网需求，设计整体解决方案

## 难点知识

1. 交换机工作原理
2. 10Gbit/s以太网技术
3. 虚拟局域网的设计， VLAN间路由配置技术 

## IEEE802.3 规范和布线介质标准

![image-20200607151726091](%E6%9D%82%E9%A1%B93.assets/image-20200607151726091.png)

### IEEE802体系结构示意图

![image-20200607151755768](%E6%9D%82%E9%A1%B93.assets/image-20200607151755768.png)

## 以太网发展主要原因

1. 开放标准，获得众多服务提供商的支持
2. 结构简单，管理方便，价格低廉
3. 持续技术改进，满足用户不断增长的需求
4. 网络可平滑升级，保护用户投资

## IEEE802.3数据帧结构

![image-20200607152014975](%E6%9D%82%E9%A1%B93.assets/image-20200607152014975.png)

## CSMA类型与CSMA/CD工作原理

### 载波监听策略：

1. 非坚持CSMA：一旦监听到信道忙，就不再监听；延迟一个随机时间后再次监听
2. 坚持CSMA：监听到信道忙时，仍继续监听，直到信道空闲
   1. 1-坚持CSMA：一听到信道空闲就立即发送数据
   2. p-坚持CSMA：听到信道空闲时，以概率p发送数据（以概率1-p延迟一段时间后再发送）

### CSMA技术不能解决发送中出现的冲突现象，，其工作原理：

发送前监听。每个站点在发送数据之前要监听信道上是否有数据在传送。若有，则此站不能发送，需等待一段时间后重试

### CSMA/CD 带冲突检测的载波监听多点访问

#### 工作原理

发送前先监听信道是否空闲，若空闲则立即发送数据。在发送时，边发边继续监听。若监听到冲突，则立即停止发送。等待一段随机时间（称为退避）以后，再重新尝试

可归结为四句话：

* 发前先侦听
* 空闲即发送
* 边发边检测
* 冲突时退避

## Ethernet/802.3操作

* 每个站点都可以接收到所有来自其他站点的数据
* 为决定那个站点接收，需要寻址机制来标识目的站点
* 目的站点将该帧复制，其他站点则丢弃该帧
* ![image-20200607152543201](%E6%9D%82%E9%A1%B93.assets/image-20200607152543201.png)

## 交换机技术与配置

交换机从本质看是一台特殊的计算机，主要由CPU、内存储器、I/O接口等部件组成

交换机接口主要是以太网接口，用于将交换机连接到网络。如10/100Mbit/s自适应电口，1000Mbit/s光口。交换机还有Console口，该端口为异步端口，主要连接终端或支持终端仿真程序的计算机，在本地配置交换机 

### 设置主机名

![image-20200607154200643](%E6%9D%82%E9%A1%B93.assets/image-20200607154200643.png)

### 配置密码

全局配置模式可设置普通用户口令和特权用户口令

![image-20200607154230652](%E6%9D%82%E9%A1%B93.assets/image-20200607154230652.png)

### 接口基本配置

交换机出厂（默认）时，交换机的以太网接口是开启的。使用时，交换机的以太网接口可配置双工通信模式和速率等

![image-20200607154302257](%E6%9D%82%E9%A1%B93.assets/image-20200607154302257.png)

### 管理地址配置

交换机运行时可通过Telnet登录，进行配置管理。

交换机需要配置一个IP地址，以便能通过PC进行Telnet。

通常，交换机管理地址是在VLAN（虚拟子网）接口上配置的。

设置默认网关IP地址，可使不同VLAN的PC机也能Telnet登录该交换机，进行运行管理

![image-20200607154351052](%E6%9D%82%E9%A1%B93.assets/image-20200607154351052.png)

### 保存配置

以上配置操作完成后，需要将配置程序保存在NVRAM。在特权用户模式下，

使用“wr”命令或“copy running-config startup-config”命令将配置程序保存

### 交换机间连接

两台交换机连接时，采用连接线缆分别连接两台设备的对应端口。两台交换机的管理IP地址设置为同一VLAN的子网地址

![image-20200607154520297](%E6%9D%82%E9%A1%B93.assets/image-20200607154520297.png)

按照以上操作步骤，设置SW2的主机名、密码、接口通信模式和速率，以及管理地址等内容。SW2的F0/1接口通信模式与速率要同SW1的F0/1接口通信模式与速率一致，如均设置为全双工、100Mbit/s

### 交换机网桥技术

#### 工作原理

网桥（bridge）工作在数据链路层，根据MAC地址（物理地址）进行数据帧接收、地址过滤与数据帧转发，以实现多个网段之间的数据帧交换

* 接收 转发 过滤

#### 交换机的帧交换规则

1. 如果数据帧的目的MAC地址是广播地址或者组播地址，则向交换机所有端口转发（除数据帧来的端口）
2. 如果数据帧的目的地址是单播地址，但这个地址并不在交换机的地址表中，那么也会向所有的端口转发（除数据帧来的端口）
3. 如果数据帧的目的地址在交换机的地址表中，那么就根据地址表转发到相应的端口
4. 如果数据帧的目的地址与数据帧的源地址在一个网段上，它就会丢弃这个数据帧，交换也就不会发生

![image-20200607154844277](%E6%9D%82%E9%A1%B93.assets/image-20200607154844277.png)

#### 构造和维护交换地址表

* 交换机的交换地址表中，一条表项主要由一个主机MAC地址和该地址位于的交换机端口号组成。整张地址表的生成采用动态自学习的方法，即当交换机收到一个数据帧以后，将数据帧的源地址和输入端口记录在交换地址表中
* 例如Cisco交换机，将交换地址表放置在内容可寻址存储器（CAM，Content Addressable Memory）中，因此也被称为CAM表
* 当然，在存放交换地址表项之前，交换机首先应该查找地址表中是否已经存在该源地址的匹配表项，仅当匹配表项不存在时才能存储该表项。每一条地址表项都有一个时间标记，用来指示该表项存储的时间周期
* 地址表项每次被使用或者被查找时，表项的时间标记就会被更新。如果在一定的时间范围内地址表项仍然没有被引用，它就会从地址表中被移走。因此，交换地址表中所维护的是有效和精确的主机MAC地址与交换机端口对应信息

#### 桥接和交换对比

* 桥接
  * 采用软件实现
  * 每个网桥有一个生成树
  * 每个网桥一般不能多于16口
* 交换
  * 基于硬件实现ASIC
  * 每个交换机内有多棵生成树
  * 交换机可以有非常多的接口

### 数据链路层交换（桥接）的运行细节

* 地址学习
* 转发/过滤决定的过程

### LAN交换机如何学习地址

* 交换机动态的学习MAC地址并将它存在内容可寻址内存(CAM—content-addressable memory)
* 每次交换机接收到一个数据帧后，向交换表中存放一个地址项，并且在该项上加上时间戳
* 当CAM中已有的相关地址的每个数据帧到达后，表中地址相关的项的时间戳将被更新
* 当地址的时间戳过期后，该项将从表中删除
* 上述更新办法将使得交换表维持在一个较小的规模

#### 地址学习

#### 交换机的交换技术

* 存储转发
  * 交换机接受整个数据帧，在转发到目的地之前，计算并校验数据帧末尾的CRC值
* 直通 Cut-through
  * 快速转发交换—在接受并读取了数据帧的目的MAC地址后就开始转发数据帧
    * 优点 降低延迟
    * 缺点 会转发错误数据
* 自由分段交换
  * 在转发数据帧之前，需要检查该数据帧是否是冲突的帧。通常由于某些网络要求数据帧必须大于64字节，因此，该方式下一般将过滤掉小于64字节的数据帧
    * 优点：减少转发的错误数据帧
    * 缺点：增加延迟

![image-20200607163006254](%E6%9D%82%E9%A1%B93.assets/image-20200607163006254.png)

### 交换机的运行方式

#### 交换机具备的两个基本功能

* 基于MAC地址建立和维护交换表(类似于网桥表)
* 将数据帧交换到连接到目的地的接口

##### 交换机和网桥的区别

* 交换机的运行速度快
* 通过微分段技术，交换机有创建虚拟局域网（VLANs）的能力
* 网桥中的数据交换通过软件完成，交换机则采用硬件来实现数据交换（叫做“交换结构”“switch fabric”）

## VLAN技术和路由配置

VLAN是在一个物理网络上划分出来的逻辑网络，它不受网络端口的实际物理位置的限制，有着和普通物理网络相同的属性，第二层的广播帧仅在一个VLAN内扩散，而不会进入其他的VLAN之中。

### 概述

* Port-VLAN--基于端口的VLAN（一个端口仅属于一个VLAN）
  * port-VLAN设置在连接主机的端口
* tag-VLAN--跨交换机实现VLAN
  * 特点
    * 传输多个VLAN的信息
    * 实现同一VLAN跨越不同额交换机
    * 要求Trunk至少要100M
  * 原理
    * 一个端口属于多个VLAN
    * Trunk口，直接与交换机相连的口。Trunk口可以识别和发送802.1Q报文

### IEEE802.1Q数据帧

![image-20200607165100958](%E6%9D%82%E9%A1%B93.assets/image-20200607165100958.png)

* 标记协议标识（TPID）
  * 固定值0x8100表示该帧载有802.1Q标记信息
* 标记控制信息（TCI）
  * Priority 3比特，表示优先级
  * Canonical format indicator 1比特 表示总线型以太网。FDDI、令牌环网
  * VLANID 12比特 表示VID 范围 1-4094

#### 工作原理

![image-20200607165343190](%E6%9D%82%E9%A1%B93.assets/image-20200607165343190.png)

#### 工作特点

* 802.1Q数据帧传输对于用户是完全透明的
* Trunk上默认会转发交换机上存在的所有VLAN的数据
* 交换机在从Trunk口转发数据前会在数据打上个Tag标签，在到达另一交换机后，再剥去此标签

### VLAN间路由

* VLAN间的主机为不同网段内的主机，不能互相通信
* 需要通过三层设备对数据进行路由转发才可以实现
  * 通过在三层交换机上为各VLAN配置SVI接口，利用三层交换机的路由功能可以实现VLAN间的路由
  * 通过路由器的子接口，可以实现VLAN间的路由

### 三层交换实现VLAN间路由

* 分别创建每个VLAN的SVI接口，并配置IP地址
* 三层交换机和二层交换机通过trunk链路相连

### VLAN的划分步骤

* 交换机上定义VLAN
* 将交换机的端口定义到已经定义好的VLAN中
* 设置trunk口
* 在三层交换机上为各VLAN配置SVI接口，利用三层交换机的路由功能可以实现VLAN间的路由

### VLAN设计原则

* 按部门或业务特点确定如何划分VLAN
* VLAN的划分和设计与IP地址的分配是密切相关的，不同VLAN内的主机需要使用不同子网的IP地址
* VLAN的划分和设计要考虑一个VLAN的主机数量不宜过多
* VLAN的划分不宜太细。因为VLAN划分太细，将导致网络中VLAN的数量很多，给VLAN的管理、IP地址的分配都带来一些不便，并且容易造成IP地址浪费

### 配置Port Vlan Access

<img src="%E6%9D%82%E9%A1%B93.assets/image-20200607165856711.png" alt="image-20200607165856711" style="zoom:67%;" />

<img src="%E6%9D%82%E9%A1%B93.assets/image-20200607165907581.png" alt="image-20200607165907581" style="zoom:50%;" />

* 连续接口 0/1-10，不连续接口用逗号隔开，但一定要写明模块编号

### 配置tag Vlan trunk

<img src="%E6%9D%82%E9%A1%B93.assets/image-20200607170247037.png" alt="image-20200607170247037" style="zoom:67%;" />

### 配置三层交换机

<img src="%E6%9D%82%E9%A1%B93.assets/image-20200607170319470.png" alt="image-20200607170319470" style="zoom:67%;" />

### VLAN与多层交换

#### VTP技术

VTP（VLAN Trunk Protocol）提供了一种在交换机管理VLAN的方法

### VTP三种模式

* 服务器模式
* 客户机模式
* 透明模式

### 多层交换

（MLS，Multilayer Switching）为交换机提供基于硬件的第三层高性能交换

MLS采用先进的专用集成电路（ASIC，Application Specific Integrated Circuit）交换部件完成子网间的IP包交换，可以大大减轻路由器在处理数据包时所引起的过高时间延迟

#### 组成

1. 多层路由处理器（MLS-RP）。MLS-RP相当于网络中的路由器，负责处理每个数据流的第一个数据包，协助MLS交换引擎（MLS-SE）在第三层的CAM（Content Addressable Memory）中建立捷径条目（Shortcut Entry）。MLS-RP可以是一个外部的路由器，也可以由三层交换机的路由交换模块（RSM）来实现
2. 多层交换的交换引擎（MLS-SE）。MLS-SE负责处理转发和重写数据包功能的交换实体
3. 多层交换协议（MLSP）。MLSP是一个协议，用来通过多层路由处理器（MLS-RP）对多层交换引擎进行初始化。
   交换机利用专业化硬件ASIC进行“一次路由，多次交换”处理数据包，速度相当快，可以达到48~176Mbit/s甚至1000Mbit/s

### VLAN间的信息传递

#### 交换机列表支持方式

Table Maintenance）。这种方式的工作步骤是：当客户机第一次在网络上广播其存在时，交换机就在自己内置的地址列表中将客户机的MAC地址或交换机的端口号与所属虚拟网一一对应起来。并不断的向其他交换机广播。如果客户机的虚拟网成员身分改变了，交换机中的地址列表将由网络管理员在控制台上手动修改。然而，随着网络规模的扩充，大量用来升级交换机地址列表的广播信息将导致主干网路上的拥塞。因此，这种方式并不太普及

#### 帧标签方式

Frame Tagging）。在这种形式下，每个数据包都在包头位置插入了一个标签以显示该数据帧属于哪个虚拟网。不同厂家的标签长度是不一样的。有时，一个数据包加上标签后的长度甚至超过了网络设备所能处理的极限。另一个问题是，数据包加上标签后使网络负载加重了

#### TDM方式

Time Division Multiplexing，时分复用）。TDM在虚拟网上的实现方式与它在广域网上的实现方式非常类似。在这里，每个虚拟网都将拥有自己的网络通路。这样，在一定程度上避免了前两者方式中所遇到的问题。但另一方面，属于某一个虚拟网的时间片断只能被该虚拟网的成员使用。所以，仍然有很多带宽被浪费了。现在，非常流行的ATM网络也允许内部的两个交换机之间交换虚拟网信息。与上述三种方式都不同的是，ATM使用一种被称作LANE（LAN Emulation，局域网仿真）的技术来实现这项功能

### VLAN间路由通信

#### 单臂路由器

路由器的以太网接口较少（一般配置2~4个），使用路由器为不同VLAN提供通信，当VLAN个数较多时，路由器的以太网接口无法直连多个VLAN的交换机。因此，提出了单臂路由解决方案

##### 配置

![image-20200607171004441](%E6%9D%82%E9%A1%B93.assets/image-20200607171004441.png)

* 在S1上划分VLAN
  * PC1以“超级终端”方式进入交换机的全局配置模式，建立VLAN2，将F0/2口设置为VLAN2
  * <img src="%E6%9D%82%E9%A1%B93.assets/image-20200607171047329.png" alt="image-20200607171047329" style="zoom:80%;" />
* 在S1上建立连接路由器R1的trunk
  * 确定F0/1接口为Trunk，在全局配置模式下，设置F0/1为Trunk，并采用802.1Q协议封装 
  * <img src="%E6%9D%82%E9%A1%B93.assets/image-20200607171143858.png" alt="image-20200607171143858" style="zoom:67%;" />
* 在R1上建立连接交换机S1的Trunk子接口
  * PC1以“超级终端”方式进入路由器的全局配置模式，确定F0/0为连接S1的物理接口。在F0/0口上分别建立子接口F0/0.1和F0/0.2，对子接口用802.1Q封装，并设置VLAN2和VLAN3的路由网关地址，激活物理端口 
  * ![image-20200607171220824](%E6%9D%82%E9%A1%B93.assets/image-20200607171220824.png)
* 在PC1和PC2上配置IP地址和网关
  * PC1的网关为192.168.2.1
  * PC2的网关为192.168.3.1
* 测试PC1和PC2的通信 

#### 第三层交换（路由）配置

采用具有三层交换功能的交换机实现不同VLAN间的路由。从使用者角度看，这种三层交换机可看作是二层交换机和路由器的组合

<img src="%E6%9D%82%E9%A1%B93.assets/image-20200607171351940.png" alt="image-20200607171351940" style="zoom:80%;" />

##### 步骤

* 在S1上划分VALN
* 在S1上建立连接SR1的Trunk
* 配置三层交换机SR1。PC1以“超级终端”方式进入SR1的全局配置模式，确定F0/1为连接S1的Trunk接口。对该接口用802.1Q封装，并设置VLAN2和VLAN3的路由网关地址，激活VLAN接口，激活IP路由
* 配置三层交换机
  * 

<img src="%E6%9D%82%E9%A1%B93.assets/image-20200607171437346.png" alt="image-20200607171437346" style="zoom:80%;" />

* 检查SR1上的IP路由表
  * <img src="%E6%9D%82%E9%A1%B93.assets/image-20200607171511907.png" alt="image-20200607171511907" style="zoom:80%;" />

* 在PC1和PC2上配置IP地址和网关。PC1的网关为192.168.2.1，PC2的网关为192.168.3.1
* 测试PC1和PC2的通信

## 交换机性能与连接技术

### 交换机性能指标

* 交换容量（Gbit/s） 背板带宽（Gbit/s） 吞吐率或包转发率（Mpps,Million Packet Per Second，每秒百万包数）  

* 端口速率
  * 端口速率即交换机端口提供给数据资源设备独享的带宽，它体现了交换机端口每秒吞吐多少数据包的能力
* 背板带宽 包转发率 延时
  * 虽然端口速率很重要，但是，影响交换速率的因素除了端口每秒能吞吐多少数据包外，还有背板带宽因素

* 交换机的延迟
  * 每个交换机增加21us的延迟
  * 通过采用不同的交换方法会降低延迟
  * 与存储-转发方法不同，交换机使用直通(cut-through)方式进行数据交换，即当交换机接收并读取到数据帧的目的MAC地址就开始转发数据帧

### LAN交换的特点

* 性能价格比较高；交换机仅比集线器贵3到5倍
* 可以创建虚拟线路。
* 管理网络方面更加有弹性
* 减少冲突的数量
* 与802.3布线系统兼容

### 均衡交换 非均衡交换

* 非均衡交换需要交换机具有存储缓冲区
* 均衡交换在存取其他网段服务器时，有瓶颈

### 交换机的连接技术

冗余连接--提高网络链路的可靠性

链路聚合----消除交换机间的带宽瓶颈

堆叠 ----增加交换机端口的密度

上连 ----扩张网络覆盖的范围

### 局域网 交换机选型

* 快速以太网交换机
* 10/100Mbit/s自适应交换机
* 千兆以太网交换机
* 万千兆以太网交换机

* 品牌选择
  * 所有网络设备尽可能选取同一厂家的产品，以便使用户从网络通信设备的性能参数、技术支持、价格等各方面获得更多的便利
* 扩展性考虑
  * 在网络的层次结构中，主干设备选择应预留一定的能力，以便于将来扩展，低端设备够用即可。因为低端设备更新较快，易于淘汰
* 量体裁衣策略
  * 根据网络实际带宽性能需求、端口类型和端口密度选型。如果是旧网改造项目，应尽可能保留可用设备，减少在资金投入方面的浪费
* 性价比高、质量可靠
  * 网络系统设备应具有较高的可靠性和性能价格比高，工程费用的投入产出应达到最大值，为用户节约资金

### 核心交换机选型要求

核心网络骨干交换机是宽带网的核心

* 高性能,高速率
* 便于升级和扩展
* 高可靠性
* 强大的网络控制能力，提供QoS（服务质量）和网络安全，支持RADIUS、TACACS+等认证机制
* 良好的可管理性，支持通用网管协议，如SNMP、RMON、RMON2等

### 汇集接入层交换机选型要求

* 灵活性
  * 提供多种固定端口数量,可堆叠,易扩展
* 高性能
  * 作为大中型网络的二级交换设备，应支持1000Mbit/s高速上连（最好支持链路聚合FEC/GEC），以及同级设备堆叠。当然还要注意与核心交换机品牌的一致性。如果用作小型网络的中心交换机，要求具有较高背板带宽和三层交换能力
* 在满足技术性能要求的基础上，最好价格便宜，使用方便，即插即用，配置简单
* 具备一定的网络服务质量和控制能力
  * （802.1x）以及端到端的QoS（服务质量）
* 如果用于跨地区企业分支部门通过公网进行远程上连的交换机，还应支持虚拟专网VPN标准协议
* 支持多级别网络管理